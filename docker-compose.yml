version: '3.8'

services:
  curator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rss-curator
    
    # Use the host network to reach qBittorrent on localhost
    network_mode: "host"
    
    # Environment variables - override with your own .env file
    env_file:
      - .env
    
    # Environment variables that can be set here or in .env
    environment:
      # Core configuration
      - RSS_FEED_URL=${RSS_FEED_URL}
      - QBITTORRENT_HOST=${QBITTORRENT_HOST:-http://localhost:8080}
      - QBITTORRENT_USER=${QBITTORRENT_USER}
      - QBITTORRENT_PASS=${QBITTORRENT_PASS}
      - QBITTORRENT_CATEGORY=${QBITTORRENT_CATEGORY:-curator}
      - STORAGE_PATH=${STORAGE_PATH:-/app/data/curator.db}
      
      # Matching configuration (legacy, if not using shows.json)
      - SHOW_NAMES=${SHOW_NAMES}
      - MIN_QUALITY=${MIN_QUALITY:-1080p}
      - PREFERRED_CODEC=${PREFERRED_CODEC:-x265}
      - PREFERRED_GROUPS=${PREFERRED_GROUPS}
      - EXCLUDE_GROUPS=${EXCLUDE_GROUPS}
      
      # Scheduler configuration
      - CHECK_INTERVAL=${CHECK_INTERVAL:-3600}
      - LOG_FILE=${LOG_FILE:-/app/logs/curator.log}
      
      # API server configuration
      - CURATOR_API_PORT=${CURATOR_API_PORT:-8081}
    
    # Volumes for persistent storage and configuration
    volumes:
      - curator-data:/app/data
      - ${PWD}/shows.json:/app/shows.json:ro
      - ${PWD}/logs:/app/logs
    
    # Restart policy - keeps both scheduler and API running
    restart: unless-stopped
    
    # Default: runs both scheduler (background) + API server (foreground)
    # To run scheduler only, override with:
    #   command: ["/app/scheduler.sh"]
    # To run API only, override with:
    #   command: ["curator", "serve"]

volumes:
  curator-data:
    driver: local

# Usage notes:
#
# 1. Default dual-mode (scheduler checks RSS, API accepts review via HTTP):
#    docker-compose up -d
#
# 2. Scheduler only (automated checks, manual CLI review):
#    docker-compose up -d
#    (then override command: ["/app/scheduler.sh"])
#
# 3. API only (manual triggers, HTTP review):
#    docker-compose up -d
#    (then override command: ["curator", "serve"])
#
# 4. Monitor logs:
#    docker-compose logs -f
#
# 5. Review torrents via API:
#    curl http://localhost:8081/torrents?status=pending
#    curl -X POST http://localhost:8081/torrents/1/approve
#    curl -X POST http://localhost:8081/torrents/2/reject
#
# 6. Stop:
#    docker-compose down
